{% extends "base.html" %}

{% block title %}Calendar | Educational Platform{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}">
{% endblock %}

{% block breadcrumb %}
    <span>Calendar</span>
{% endblock %}

{% block page_title %}Calendar{% endblock %}

{% block content %}

<div class="calendar-container">
    <div class="calendar-header">
        <h2>Calendar</h2>
    </div>
    <div class="calendar-sync">
        <h3>Sync with Google Calendar</h3>
        <button id="sync-push">Push App Events to Google</button>
        <button id="sync-pull">Pull Google Events to App</button>
        <button id="sync-twoway">Two-way Sync</button>
        <div id="sync-status" class="calendar-sync-status"></div>
    </div>
    <div id="calendar"></div>
</div>

{% endblock %}

{% block scripts %}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]');

    if (!csrfToken) {
        console.error('CSRF token not found');
        return;
    }

    const headers = {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken.getAttribute('content')};

    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      events: function(info, successCallback, failureCallback) {
        fetch('/api/calendar/events?' + new URLSearchParams({
          start: info.startStr,
          end: info.endStr
        }), headers)
        .then(response => response.json())
        .then(data => {
          // Add event type styling
          const events = data.map(event => ({
            ...event,
            className: `event-${event.event_type}`,
            extendedProps: {
              event_type: event.event_type,
              description: event.description,
              location: event.location
            }
          }));
          successCallback(events);
        })
        .catch(error => {
          console.error('Error fetching events:', error);
          failureCallback(error);
        });
      },
      editable: true,
      selectable: true,
      selectMirror: true,
      dayMaxEvents: true,
      weekends: true,
      
      // Handle event creation
      select: function(arg) {
        var title = prompt('Event Title:');
        if (title) {
          calendar.addEvent({
            title: title,
            start: arg.start,
            end: arg.end,
            allDay: arg.allDay
          });
          
          // Save to backend
          fetch('/api/calendar/events', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
              title: title,
              start_datetime: arg.start.toISOString(),
              end_datetime: arg.end ? arg.end.toISOString() : null,
              event_type: 'study_session' // Default type
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              console.error('Error creating event:', data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
        }
        calendar.unselect();
      },
      
      // Handle event editing
      eventClick: function(info) {
        var title = prompt('Edit Event Title:', info.event.title);
        if (title !== null) {
          info.event.setProp('title', title);
          
          // Update in backend
          fetch(`/api/calendar/events/${info.event.id}`, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify({
              title: title
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              console.error('Error updating event:', data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
        }
      },
      
      // Handle event deletion
      eventDrop: function(info) {
        // Update event dates in backend
        fetch(`/api/calendar/events/${info.event.id}`, {
          method: 'PUT',
          headers: headers,
          body: JSON.stringify({
            start_datetime: info.event.start.toISOString(),
            end_datetime: info.event.end ? info.event.end.toISOString() : null
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            console.error('Error updating event:', data.error);
            info.revert();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          info.revert();
        });
      }
    });
    calendar.render();

    // --- Google Calendar Sync Buttons ---
    function setSyncStatus(msg, isError) {
      const statusDiv = document.getElementById('sync-status');
      statusDiv.textContent = msg;
      statusDiv.style.color = isError ? '#dc3545' : '#28a745';
    }

    function handleSync(endpoint, label) {
      setSyncStatus(`Syncing: ${label}...`, false);
      fetch(endpoint, { method: 'POST', headers: headers })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            setSyncStatus(`Error: ${data.error}`, true);
          } else {
            setSyncStatus(data.message || `${label} completed!`, false);
            // Optionally refresh calendar events after sync
            calendar.refetchEvents();
          }
        })
        .catch(err => {
          setSyncStatus(`Error: ${err}`, true);
        });
    }

    document.getElementById('sync-push').addEventListener('click', function() {
      handleSync('/api/calendar/sync/push', 'Push App Events to Google');
    });
    document.getElementById('sync-pull').addEventListener('click', function() {
      handleSync('/api/calendar/sync/pull', 'Pull Google Events to App');
    });
    document.getElementById('sync-twoway').addEventListener('click', function() {
      handleSync('/api/calendar/sync/twoway', 'Two-way Sync');
    });
  });
</script>
{% endblock %}

